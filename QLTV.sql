DROP DATABASE QLTV
CREATE DATABASE QLTV

USE QLTV

CREATE TABLE BAITAP 
(
	MABT VARCHAR(5) CONSTRAINT PK_BT PRIMARY KEY,
	MADK VARCHAR(5),
	TENBT VARCHAR(50)
)

CREATE TABLE DOKHO
(
	MADK VARCHAR(5) CONSTRAINT PK_DK PRIMARY KEY,
	DIEMDK INT
)

CREATE TABLE NOPBAI
(
	MABN VARCHAR(5) CONSTRAINT PK_BN PRIMARY KEY,
	MATV VARCHAR(5),
	MABT VARCHAR(5),
	NGAYNOP SMALLDATETIME,
	DIEMHT INT
)

CREATE TABLE THANHVIEN
(
	MATV VARCHAR(5) CONSTRAINT PK_TV PRIMARY KEY,
	TENTV VARCHAR(50),
	THUHANG INT,
	LOAITV VARCHAR(50),
	NGDK SMALLDATETIME
)


ALTER TABLE BAITAP
ADD CONSTRAINT Fk_BT_DK FOREIGN KEY (MADK) REFERENCES DOKHO(MADK)

ALTER TABLE NOPBAI
ADD CONSTRAINT Fk_NB FOREIGN KEY (MATV) REFERENCES THANHVIEN(MATV)

ALTER TABLE NOPBAI
ADD CONSTRAINT Fk_NB_BT FOREIGN KEY (MABT) REFERENCES BAITAP(MABT)

SET DATEFORMAT DMY

INSERT INTO DOKHO VALUES ('1', '20')
INSERT INTO DOKHO VALUES ('2', '40')
INSERT INTO DOKHO VALUES ('3', '60')

INSERT INTO THANHVIEN VALUES ('TV1', 'Ngô Thế Phương', '70', 'Member', '28/12/2017')
INSERT INTO THANHVIEN VALUES ('TV2', 'Hồ Mẫn Đạt', '45', 'Moderator', '11/11/2017')
INSERT INTO THANHVIEN VALUES ('TV3', 'Nguyễn Tiến Lâm', '60', 'Member', '25/10/2017')

INSERT INTO BAITAP VALUES ('BT1', '2', 'Binary tree')
INSERT INTO BAITAP VALUES ('BT2', '1', 'Linked list')
INSERT INTO BAITAP VALUES ('BT3', '3', 'Hash')

INSERT INTO NOPBAI VALUES ('BN1', 'TV1', 'BT2', '20/10/2018', '20')
INSERT INTO NOPBAI VALUES ('BN2', 'TV1', 'BT3', '20/10/2018', '60')
INSERT INTO NOPBAI VALUES ('BN3', 'TV1', 'BT1', '21/10/2018', '40')
INSERT INTO NOPBAI VALUES ('BN4', 'TV2', 'BT1', '21/10/2018', '20')
DELETE NOPBAI WHERE MABN='BN4'
SELECT*FROM NOPBAI
--3. Hiện thực ràng buộc toàn vẹn sau: thành viên loại ‘Moderator’ phải có thứ hạng từ 40 trở 
--lên (1đ).
ALTER TABLE THANHVIEN
ADD CONSTRAINT KT_TV CHECK (LOAITV!='Moderator' OR (LOAITV='Moderator' AND THUHANG>=40))
--4. Hiện thực ràng buộc toàn vẹn sau: điểm từ hệ thống chấm không được lớn hơn điểm tối đa
--của bài tập (2đ).

--TRIGGER ON NOPBAI
CREATE TRIGGER TRIGGER_INSERT_UPDATE_NB ON NOPBAI
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @DIEMHT INT, @DIEMDK INT

	SELECT @DIEMDK=DIEMDK, @DIEMHT=DIEMHT
	FROM INSERTED NB, BAITAP BT, DOKHO DK
	WHERE NB.MABT=BT.MABT AND BT.MADK=DK.MADK

	IF(@DIEMHT>@DIEMDK)
		BEGIN
			PRINT 'ERROR!: DIEMHT PHAI (<=) DIEMDK CUA BAI TAP TUONG UNG'
			ROLLBACK TRAN
		END
	ELSE
		PRINT 'THANH CONG'
END

--TRIGGER ON BAITAP
CREATE TRIGGER TRIGGER_INSERT_UPDATE_BT ON BAITAP
FOR UPDATE
AS
BEGIN
	IF EXISTS(SELECT *
	          FROM INSERTED BT, DOKHO DK, NOPBAI NB
			  WHERE BT.MADK=DK.MADK AND BT.MABT=NB.MABT
			        AND NB.DIEMHT>DK.DIEMDK)
		BEGIN
			PRINT 'ERROR!: SỬA DIEMHT TRƯỚC SAO CHO <= DIEMDK CỦA BÀI TẬP'
			ROLLBACK TRAN
		END
	ELSE
		PRINT 'THANH CONG!'
END
INSERT INTO BAITAP VALUES ('BT4', '3', 'Hash')
INSERT INTO NOPBAI VALUES ('BN4', 'TV3', 'BT4', '21/10/2018', '60')
DELETE FROM NOPBAI WHERE MABN='BN4'
DELETE FROM BAITAP WHERE MABT='BT4'

UPDATE BAITAP
SET MADK='3'
WHERE MABT='BT4'
--TRIGGER ON DOKHO
CREATE TRIGGER TRIGGER_INSERT_UPDATE_DK ON DOKHO
FOR UPDATE
AS
BEGIN
	IF EXISTS(SELECT *
	          FROM INSERTED DK, NOPBAI NB, BAITAP BT
			  WHERE BT.MADK=DK.MADK AND BT.MABT=NB.MABT
			        AND NB.DIEMHT>DK.DIEMDK)
		BEGIN
			PRINT 'ERROR!: SỬA DIEMHT TRƯỚC SAO CHO <= DIEMDK CỦA BÀI TẬP TƯƠNG ỨNG'
			ROLLBACK TRAN
		END
	ELSE
		PRINT 'THANH CONG!'
END
UPDATE DOKHO
SET DIEMDK='70'
WHERE MADK='3'
--5. Tìm tất cả thành viên (MATV, TEN) giải được bài tập có độ khó mức 2, sắp xếp kết quả tăng 
--dần theo tên thành viên (1đ).
SELECT TV.MATV, TENTV
FROM THANHVIEN TV, NOPBAI NB, BAITAP BT
WHERE TV.MATV=NB.MATV AND NB.MABT=BT.MABT AND MADK='2'
ORDER BY TENTV ASC
--6. Tìm tất cả thành viên (MATV, TEN) không giải bài tập nào trong năm 2017 (1đ).
SELECT MATV, TENTV
FROM THANHVIEN
EXCEPT
SELECT TV.MATV, TENTV
FROM THANHVIEN TV, NOPBAI NB
WHERE TV.MATV=NB.MATV AND YEAR(NGAYNOP)=2017

SELECT MATV, TENTV
FROM THANHVIEN TV
EXCEPT
SELECT TV.MATV, TV.TENTV
FROM THANHVIEN TV, NOPBAI NB
WHERE TV.MATV = NB.MATV
      AND YEAR(NB.NGAYNOP) = 2017
--7. Tìm tất cả thành viên (MATV, TEN) có tổng điểm cao thứ 2 trong tháng 10/2018 (1đ).
SELECT TOP 1 WITH TIES TV.MATV, TENTV
FROM THANHVIEN TV, NOPBAI NB
WHERE TV.MATV=NB.MATV AND MONTH(NGAYNOP)=10 AND YEAR(NGAYNOP)=2018
      AND TV.MATV NOT IN (	SELECT TOP 1 WITH TIES TV.MATV
							FROM THANHVIEN TV, NOPBAI NB
							WHERE TV.MATV=NB.MATV AND MONTH(NGAYNOP)=10 AND YEAR(NGAYNOP)=2018
							GROUP BY TV.MATV
							ORDER BY SUM(DIEMHT) DESC)
GROUP BY TV.MATV, TENTV
ORDER BY SUM(DIEMHT) DESC

SELECT TOP 2 WITH TIES TV.MATV, TENTV
FROM THANHVIEN TV, NOPBAI NB
WHERE TV.MATV=NB.MATV AND MONTH(NGAYNOP)=10 AND YEAR(NGAYNOP)=2018
EXCEPT 
SELECT TOP 2 WITH TIES TV.MATV, TENTV
FROM THANHVIEN TV, NOPBAI NB
WHERE TV.MATV=NB.MATV AND MONTH(NGAYNOP)=10 AND YEAR(NGAYNOP)=2018
GROUP BY TV.MATV, TENTV
ORDER BY SUM(DIEMHT) DESC

--SELECT TOP 2 WITH TIES TV.MATV, TV.TENTV, SUM(NB.DIEMHT) AS TONGDIEM
--FROM THANHVIEN TV, NOPBAI NB
--WHERE TV.MATV = NB.MATV
--GROUP BY TV.MATV
--ORDER BY SUM(NB.DIEMHT) DESC
--EXCEPT
--SELECT TOP 1 WITH TIES TV.MATV, TV.TENTV, SUM(NB.DIEMHT) AS TONGDIEM
--FROM THANHVIEN TV, NOPBAI NB
--WHERE TV.MATV = NB.MATV
--GROUP BY TV.MATV
--ORDER BY SUM(NB.DIEMHT) DESC
--8. Tìm tất cả thành viên (MATV, TEN) giải được bài tập ở tất cả các mức độ khó (1đ).
SELECT MATV, TENTV
FROM THANHVIEN TV
WHERE NOT EXISTS (SELECT *
                  FROM BAITAP BT, DOKHO DK
				  WHERE BT.MADK=DK.MADK
				        AND NOT EXISTS(SELECT *
						               FROM NOPBAI NB
									   WHERE NB.MABT=BT.MABT AND NB.MATV=TV.MATV))

--11. Trong 2 khách hàng có doanh số cao nhất, tìm khách hàng (Tên khách hàng, Địa chỉ, Số
--điện thoại) có lượt đi mua thuốc nhiều nhất. (1.25đ)
SELECT TENKH, DIACHI, SDT
FROM KHACHHANG KH1
INNER JOIN DONTHUOC DT1 ON KH1.MAKH=DT1.MAKH
GROUP BY TENKH, DIACHI, SDT
HAVING COUNT(MADT)>=ALL(SELECT COUNT(MADT)
			            FROM DONTHUOC DT2
			            WHERE MAKH IN (	SELECT TOP 2 MAKH	
										FROM KHACHHANG KH2, DONTHUOC DT3
										WHERE KH2.MAKH=HD2.MAKH AND KH2.MAKH=DT3.MAKH
										GROUP BY MAKH
										ORDER BY SUM(THANHTIEN) DESC)
						GROUP BY MAKH
						)