DROP DATABASE 
CREATE DATABASE QLCHCC

USE QLCHCC

CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(5) CONSTRAINT PK_KH PRIMARY KEY,
	TENKH VARCHAR(50),
	DIACHI VARCHAR(50),
	LOAIKH VARCHAR(50)
)

CREATE TABLE LOAICAY
(
	MALC VARCHAR(5) CONSTRAINT PK_LC PRIMARY KEY,
	TENLC VARCHAR(50),
	XUATXU VARCHAR(50),
	GIA MONEY
)

CREATE TABLE HOADON
(
	SOHD VARCHAR(5) CONSTRAINT PK_HD PRIMARY KEY,
	NGHD SMALLDATETIME,
	MAKH VARCHAR(5),
	KHUYENMAI INT
)

CREATE TABLE CTHD
(
	SOHD VARCHAR(5),
	MALC VARCHAR (5),
	SOLUONG INT,
	CONSTRAINT PK_CT PRIMARY KEY (SOHD, MALC)
)

ALTER TABLE HOADON
ADD CONSTRAINT Fk_HD_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE CTHD
ADD CONSTRAINT Fk_CT_HD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD)

ALTER TABLE CTHD 
ADD CONSTRAINT Fk_CT_LC FOREIGN KEY (MALC) REFERENCES LOAICAY(MALC)

SET DATEFORMAT DMY

INSERT INTO KHACHHANG VALUES('KH01', 'Liz Kim Cuong', 'Ha Noi', 'Vang lai')
INSERT INTO KHACHHANG VALUES('KH02', 'Ivone Dieu Linh', 'Da Nang', 'Thuong xuyen')
INSERT INTO KHACHHANG VALUES('KH03', 'Emma Nhat Khanh', 'TP.HCM', 'Vang lai')

INSERT INTO LOAICAY VALUES ('LC01', 'Xuong rong tai tho', 'Mexico', '180000')
INSERT INTO LOAICAY VALUES ('LC02', ',Sen thach ngoc', 'Anh', '300000')
INSERT INTO LOAICAY VALUES ('LC03', 'Ba mau rau', 'Nam Phi', '270000')

INSERT INTO HOADON VALUES ('00001', '22/11/2017', 'KH01', '5')
INSERT INTO HOADON VALUES ('00002', '04/12/2017', 'KH03', '5')
INSERT INTO HOADON VALUES ('00003', '10/12/2017', 'KH02', '10')

INSERT INTO CTHD VALUES ('00001', 'LC01', '1')
INSERT INTO CTHD VALUES ('00001', 'LC02', '2')
INSERT INTO CTHD VALUES ('00001', 'LC03', '2')
INSERT INTO CTHD VALUES ('00003', 'LC03', '5')

--3. Hiện thực ràng buộc toàn vẹn sau: Tất cả các mặt hàng xuất xứ từ nước Anh đều có giá lớn
--hơn 250.000đ (1đ).
CREATE TRIGGER TRIGGER_INSERT_UPDATE_LC ON LOAICAY
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @XUATXU VARCHAR(50), @GIA MONEY

	SELECT @XUATXU=XUATXU, @GIA=GIA
	FROM INSERTED

	IF(@XUATXU='Anh')
		IF(@GIA<=250000)
			BEGIN
				PRINT 'ERROR!'
				ROLLBACK TRAN
			END
		ELSE
			PRINT 'THANH CONG'
END
--4. Hiện thực ràng buộc toàn vẹn sau: Hóa đơn mua với số lượng tổng cộng lớn hơn hoặc bằng 
--5 đều được giảm giá 10 phần trăm. (2đ).
CREATE TRIGGER TRIGGER_INSERT_UPDATE_CT ON CTHD
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @TONGSL INT, @KHUYENMAI INT

	SET @TONGSL = (SELECT SUM(SOLUONG)
	               FROM INSERTED)
	SET @KHUYENMAI = (SELECT KHUYENMAI
	                  FROM HOADON)
	IF(@TONGSL>=5)
		IF(@KHUYENMAI !=10)
			BEGIN	
				PRINT 'ERROR!'
				ROLLBACK TRAN
			END
		ELSE
			PRINT 'THANH CONG'

END
CREATE TRIGGER TRIGGER_UPDATE_HD ON HOADON
FOR UPDATE
AS
BEGIN
	DECLARE @TONGSL INT, @KHUYENMAI INT

	SET @TONGSL = (SELECT SUM(SOLUONG)
	               FROM CTHD CT)
	IF(@TONGSL>=5)
		IF (EXISTS (SELECT *
		            FROM INSERTED
					WHERE KHUYENMAI!=10))
			BEGIN	
				PRINT 'ERROR!'
				ROLLBACK TRAN
			END
		ELSE
			PRINT 'THANH CONG'

END
--5. Tìm tất cả các hóa đơn có ngày lập hóa đơn trong quý 4 năm 2017, sắp xếp kết quả tăng dần 
--theo phần trăm giảm giá (1đ).
SELECT SOHD
FROM HOADON
WHERE DATEPART(QUARTER,NGHD)=4 AND YEAR(NGHD)=2017
ORDER BY KHUYENMAI ASC
--6. Tìm loại cây có số lượng mua ít nhất trong tháng 12 (1đ).
SELECT LC.MALC, TENLC
FROM LOAICAY LC, CTHD CT, HOADON HD
WHERE LC.MALC=CT.MALC AND CT.SOHD=HD.SOHD
      AND MONTH(NGHD)=12
GROUP BY LC.MALC, TENLC
HAVING SUM(SOLUONG) <= ALL(SELECT SUM(SOLUONG)
                           FROM CTHD CT, HOADON HD
						   WHERE CT.SOHD=HD.SOHD AND MONTH(NGHD)=12
						   GROUP BY MALC)
--7. Tìm loại cây mà cả khách thường xuyên (LOAIKH là ‘Thuong xuyen’) và khách vãng lai
--(LOAIKH là ‘Vang lai’) đều mua. (1đ).
SELECT LC.MALC, TENLC
FROM LOAICAY LC, CTHD CT, HOADON HD, KHACHHANG KH
WHERE LC.MALC=CT.MALC AND CT.SOHD=HD.SOHD AND HD.MAKH= KH.MAKH
      AND LOAIKH='Thuong xuyen'
INTERSECT
SELECT LC.MALC, TENLC
FROM LOAICAY LC, CTHD CT, HOADON HD, KHACHHANG KH
WHERE LC.MALC=CT.MALC AND CT.SOHD=HD.SOHD AND HD.MAKH= KH.MAKH
      AND LOAIKH='Vang lai'
--8. Tìm khách hàng đã từng mua tất cả các loại cây (1đ).
SELECT KH.MAKH, TENKH
FROM KHACHHANG KH, HOADON HD
WHERE KH.MAKH=HD.MAKH AND 
      NOT EXISTS (SELECT *
                  FROM LOAICAY LC
				  WHERE NOT EXISTS (SELECT *
				                    FROM CTHD CT
									WHERE CT.SOHD=HD.SOHD AND CT.MALC=LC.MALC))

