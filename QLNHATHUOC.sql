DROP DATABASE QLNHATHUOC
CREATE DATABASE QLNHATHUOC

USE QLNHATHUOC

CREATE TABLE NHATHUOC
(
	MANT VARCHAR(20) CONSTRAINT PK_NT PRIMARY KEY,
	TENNT NVARCHAR(40),
	DIACHI NVARCHAR(40),
	SODT VARCHAR(10)
)

CREATE TABLE NHACUNGCAP
(
	MANCC VARCHAR(20) CONSTRAINT PK_NCC PRIMARY KEY,
	TENNCC NVARCHAR(40),
	DIACHI NVARCHAR(60)
)

CREATE TABLE THUOC
(
	MATHUOC VARCHAR(20) CONSTRAINT PK_TH PRIMARY KEY,
	TENTHUOC NVARCHAR(40),
	LOAI NVARCHAR(20),
	DVT NVARCHAR(20),
	GIA MONEY,
	MANCC VARCHAR(20)
)

CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(20) CONSTRAINT PK_KH PRIMARY KEY,
	TENKH NVARCHAR(40),
	NGAYSINH SMALLDATETIME,
	DIACHI NVARCHAR(60),
	SDT VARCHAR(10)

)
CREATE TABLE DONTHUOC
(
	MADT VARCHAR(20) CONSTRAINT PK_DT PRIMARY KEY,
	NGAYLAP SMALLDATETIME,
	MAKH VARCHAR(20),
	MANT VARCHAR(20),
	THANHTIEN MONEY,
	GHICHU NVARCHAR(100)
)
CREATE TABLE CTDT
(
	MADT VARCHAR(20),
	MATHUOC VARCHAR(20),
	SOLUONG INT,
	CONSTRAINT PK_CT PRIMARY KEY (MADT, MATHUOC)
)

ALTER TABLE THUOC
ADD CONSTRAINT FK_TH_NCC FOREIGN KEY (MANCC) REFERENCES NHACUNGCAP(MANCC)

ALTER TABLE DONTHUOC
ADD CONSTRAINT FK_DT_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE DONTHUOC
ADD CONSTRAINT FK_DT_NT FOREIGN KEY (MANT) REFERENCES NHATHUOC(MANT)

ALTER TABLE CTDT
ADD CONSTRAINT FK_CT_DT FOREIGN KEY (MADT) REFERENCES DONTHUOC(MADT)

ALTER TABLE CTDT
ADD CONSTRAINT FK_DT_TH FOREIGN KEY (MATHUOC) REFERENCES THUOC(MATHUOC)

SET DATEFORMAT DMY

INSERT INTO NHATHUOC VALUES ('NT001', 'Chi nhanh 1', '80 Nguyen Trai', '0125555555')
INSERT INTO NHATHUOC VALUES ('NT002', 'Chi nhanh 2', '05 Hung Vuong', '0124444444')

INSERT INTO NHACUNGCAP VALUES ('NCC001', 'Pharmacy', '1 Cong Hoa')
INSERT INTO NHACUNGCAP VALUES ('NCC002', 'Eco', '45/3 Nguyen Hue')
INSERT INTO NHACUNGCAP VALUES ('NCC003', 'Phuc An Khang', '5 Nguyen Du')

INSERT INTO THUOC VALUES ('T001', 'VitaminPP', 'Thuoc bo', 'Vi', '20000', 'NCC001')
INSERT INTO THUOC VALUES ('T002', 'Neutasol', 'Thuoc boi', 'Lo', '15000', 'NCC003')
INSERT INTO THUOC VALUES ('T003', 'Jex', 'Giam dau', 'Lo', '630000', 'NCC001')
INSERT INTO THUOC VALUES ('T004', 'Dencorub', 'Giam dau', 'Hop', '290000', 'NCC001')
INSERT INTO THUOC VALUES ('T005', 'Decazym', 'Giam dau', 'Hop', '150000', 'NCC002')
INSERT INTO THUOC VALUES ('T006', 'Pluszs', 'Thuoc bo', 'Lo', '12000', 'NCC001')

INSERT INTO KHACHHANG VALUES ('KH001', 'Nguyen Van A', '1/1/1990', '05 Phu Dong', '0888888888')
INSERT INTO KHACHHANG VALUES ('KH002', 'Tran Thi B', '23/07/1999', '15 Luy Ban Bich', '0256754444')
INSERT INTO KHACHHANG VALUES ('KH003', 'Le Long C', '4/5/2003', '3 Nguyen Trai', '0231313113')

INSERT INTO DONTHUOC VALUES ('DT001', '1/1/2021', 'KH003', 'NT001', '124000', NULL)
INSERT INTO DONTHUOC VALUES ('DT002', '3/2/2021', 'KH001', 'NT001', '20000', NULL)
INSERT INTO DONTHUOC VALUES ('DT003', '3/2/2021', 'KH003', 'NT001', '50000', NULL)
INSERT INTO DONTHUOC VALUES ('DT004', '1/5/2021', 'KH002', 'NT002', '300000', NULL)
INSERT INTO DONTHUOC VALUES ('DT005', '2/9/2021', 'KH001', 'NT001', '2295000', NULL)
INSERT INTO DONTHUOC VALUES ('DT006', '12/12/2021', 'KH001', 'NT001', '162000', NULL)

INSERT INTO CTDT VALUES ('DT001', 'T001', '5')
INSERT INTO CTDT VALUES ('DT001', 'T006', '2')
INSERT INTO CTDT VALUES ('DT002', 'T001', '1')
INSERT INTO CTDT VALUES ('DT003', 'T001', '1')
INSERT INTO CTDT VALUES ('DT003', 'T002', '2')
INSERT INTO CTDT VALUES ('DT004', 'T002', '10')
INSERT INTO CTDT VALUES ('DT004', 'T005', '1')
INSERT INTO CTDT VALUES ('DT005', 'T002', '1')
INSERT INTO CTDT VALUES ('DT005', 'T003', '2')
INSERT INTO CTDT VALUES ('DT005', 'T004', '3')
INSERT INTO CTDT VALUES ('DT005', 'T005', '1')
INSERT INTO CTDT VALUES ('DT005', 'T006', '1')
INSERT INTO CTDT VALUES ('DT006', 'T006', '1')
--Phần 1:
--1. Tạo bảng, tạo các ràng buộc khóa chính (thuộc tính gạch dưới) và khóa ngoại tương ứng.
--(1đ)
--2. Thêm cột GHICHU (kiểu dữ liệu Nvarchar(100)) vào bảng THUOC. (0.5đ)
ALTER TABLE THUOC
ADD GHICHU NVARCHAR(100)
--3. Thêm dữ liệu vào các bảng bằng dữ liệu mẫu đã được cung cấp. (1đ)
--Phần 2:
--4. Hiện thực RBTV: Đơn vị tính của thuốc phải là “Vien”, “Vi”, “Hop” hoặc “Lo”. (0.5đ)
ALTER TABLE THUOC
ADD CONSTRAINT CK_TH_DVT CHECK (DVT IN ('Vi', 'Hop', 'Lo'))
--5. Cập nhật cột GHICHU cho những thuốc có loại là “Giam dau” với nội dung là “Co tac dung 
--phu”. (0.5đ)
UPDATE THUOC
SET GHICHU='Co tac dung phu'
WHERE LOAI='Giam dau'
--Phần 3:
--6. Tìm những thuốc (Mã thuốc, tên thuốc) có giá lớn hơn 20000 và nhà cung cấp là “Pharmacy”
--(1đ)
SELECT MATHUOC, TENTHUOC
FROM THUOC TH, NHACUNGCAP NCC
WHERE TH.MANCC=NCC.MANCC AND GIA>20000 AND TENNCC='Pharmacy'
--7. Tìm những nhà cung cấp (Tên nhà cung cấp, Địa chỉ) có thuốc được bán ra ngày 1/5/2021.
--(1đ)
SELECT TENNCC, DIACHI
FROM NHACUNGCAP NCC, THUOC TH, CTDT CT, DONTHUOC DT
WHERE NCC.MANCC=TH.MANCC AND TH.MATHUOC=CT.MATHUOC AND CT.MADT=DT.MADT
      AND NGAYLAP='1/5/2021'
--8. Trong ngày 3/2/2021, khách hàng nào (Tên khách hàng, Địa chỉ, Số điện thoại) đã mua thuốc 
--“VitaminPP” và “Neutasol”. (1đ)
SELECT TENKH, DIACHI, SDT
FROM KHACHHANG KH, DONTHUOC DT, CTDT CT, THUOC TH
WHERE KH.MAKH=DT.MAKH AND DT.MADT=CT.MADT AND CT.MATHUOC=TH.MATHUOC
      AND TENTHUOC='VitaminPP'
UNION
SELECT TENKH, DIACHI, SDT
FROM KHACHHANG KH, DONTHUOC DT, CTDT CT, THUOC TH
WHERE KH.MAKH=DT.MAKH AND DT.MADT=CT.MADT AND CT.MATHUOC=TH.MATHUOC
      AND TENTHUOC='Neutasol'
--9. Tìm khách hàng đã mua tất cả các thuốc. (1đ)
SELECT MAKH, TENKH
FROM KHACHHANG KH
WHERE NOT EXISTS (SELECT*
                  FROM THUOC TH
				  WHERE NOT EXISTS (SELECT*
						            FROM DONTHUOC DT, CTDT CT
								    WHERE TH.MATHUOC=CT.MATHUOC
				                          AND DT.MADT=CT.MADT) AND DT.MAKH=KH.MAKH))

SELECT DT.MAKH, TENKH
FROM KHACHHANG KH, DONTHUOC DT
WHERE KH.MAKH=DT.MAKH 
      AND NOT EXISTS (SELECT*
					  FROM THUOC TH
					  WHERE NOT EXISTS (SELECT*
									    FROM CTDT CT
										WHERE TH.MATHUOC=CT.MATHUOC
											  ))
--10. Thống kê doanh thu của nhà thuốc có mã “NT001” theo từng tháng trong năm 2021, sắp 
--xếp theo chiều giảm dần doanh thu. (1.25đ)
SELECT MONTH(NGAYLAP) AS THANG, SUM(THANHTIEN) AS DOANHTHU
FROM DONTHUOC DT, NHATHUOC NT
WHERE DT.MANT=NT.MANT AND YEAR(NGAYLAP)=2021 AND NT.MANT='NT001'
GROUP BY MONTH(NGAYLAP)
ORDER BY SUM(THANHTIEN) DESC
--11. Trong 2 khách hàng có doanh số cao nhất, tìm khách hàng (Tên khách hàng, Địa chỉ, Số
--điện thoại) có lượt đi mua thuốc nhiều nhất. (1.25đ)
SELECT TENKH, DIACHI, SDT
FROM KHACHHANG KH1, DONTHUOC DT1
WHERE KH1.MAKH=DT1.MAKH
GROUP BY TENKH, DIACHI, SDT
HAVING COUNT(DT1.MADT) >= ALL (SELECT TOP 2 COUNT(MADT)
                               FROM DONTHUOC
							   GROUP BY MAKH
							   ORDER BY SUM(THANHTIEN) DESC)

SELECT TOP 1 TENKH, DIACHI, SDT
FROM KHACHHANG KH1, CTDT CT, DONTHUOC DT
WHERE KH1.MAKH=DT.MAKH AND DT.MADT=CT.MADT
GROUP BY TENKH, DIACHI, SDT
HAVING COUNT(DT.MADT)>=ALL(	SELECT MAKH, COUNT(DT2.MADT)--SL THUỐC MUA CỦA 2 THẰNG CAO NHẤT
							FROM DONTHUOC DT2, CTDT C
							WHERE C.MADT=DT2.MADT AND MAKH IN (	SELECT TOP 2 KH2.MAKH	
																FROM KHACHHANG KH2, DONTHUOC DT3
																WHERE KH2.MAKH=KH2.MAKH AND KH2.MAKH=DT3.MAKH
																GROUP BY KH2.MAKH
																ORDER BY SUM(THANHTIEN) DESC)--2DS CAO NHẤT
							GROUP BY MAKH)